<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mine Farm World Builder</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* ======================================= */
        /* == Minecraft Theme Variables & Global == */
        /* ======================================= */
        :root {
            --mc-dirt: #855d4d;
            --mc-grass: #72aa39;
            --mc-water: #4f80e0;
            --mc-stone: #a0a0a0;
            --mc-coal: #3c3c3c;
            --mc-iron: #c9c9c9;
            --mc-diamond: #6af7ff;
            --mc-border-dark: #3c3c3c;
            --mc-inventory-bg: #8b8b8b;
            --mc-text-shadow: 2px 2px 0px #000000;
        }

        body {
            background-color: var(--mc-stone); 
            color: white;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            overflow: hidden;
            text-shadow: var(--mc-text-shadow);
            font-size: 10px;
        }

        /* MC Block Style - –†–∞–º–∫–∏ —Ç–∞ —Ç—ñ–Ω—ñ –¥–ª—è UI */
        .mc-ui {
            border: 2px solid var(--mc-border-dark);
            box-shadow: 4px 4px 0px var(--mc-border-dark);
            background-color: var(--mc-inventory-bg);
            padding: 8px;
            margin-bottom: 10px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        /* MC –ö–Ω–æ–ø–∫–∏ */
        .mc-button {
            padding: 12px;
            background-color: #a0a0a0;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
            cursor: pointer;
            transition: all 0.05s;
            text-shadow: var(--mc-text-shadow);
        }
        .mc-button:active {
            box-shadow: 2px 2px 0px #000;
            transform: translate(2px, 2px);
        }
        
        /* –ó–∞–≥–∞–ª—å–Ω—ñ –º–µ–Ω—é */
        #main-menu, #world-menu, #create-world-menu, #skin-shop-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 350px;
            margin-top: 20px;
            text-align: center;
        }
        
        /* Input Field Style */
        .mc-input {
            padding: 10px;
            background-color: #c6c6c6;
            border: 3px solid #000;
            box-shadow: inset 1px 1px 0px #fff, inset -1px -1px 0px #3c3c3c;
            font-family: inherit;
            font-size: 10px;
            color: #000;
        }

        /* ======================================= */
        /* == Game World (2D Viewport) == */
        /* ======================================= */
        #world-viewport {
            width: 95%;
            height: 50%;
            border: 4px solid var(--mc-border-dark);
            overflow: hidden;
            display: grid;
            grid-template-columns: repeat(var(--world-cols), 1fr);
            grid-auto-rows: minmax(min-content, 1fr);
        }

        .block {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 20px;
            cursor: pointer;
            color: black;
        }
        
        /* –°—Ç–∏–ª—ñ –ë–ª–æ–∫—ñ–≤ */
        .block-air { background-color: #87ceeb; } /* –ù–µ–±–æ */
        .block-grass { background-color: var(--mc-grass); color: #000; }
        .block-dirt { background-color: var(--mc-dirt); color: #000; }
        .block-stone { background-color: var(--mc-stone); color: #000; }
        .block-water { background-color: var(--mc-water); color: #000; }
        .block-coal { background-color: var(--mc-coal); color: white; }
        .block-iron { background-color: var(--mc-iron); color: var(--mc-border-dark); }
        .block-diamond { background-color: var(--mc-diamond); color: #000; }
        .block-log { background-color: #6d4d3d; color: #000; }

        .block.damaged {
             /* –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è */
            box-shadow: inset 0 0 10px 1px rgba(255, 0, 0, 0.5);
        }

        /* ======================================= */
        /* == Progress Bar (Health Bar) == */
        /* ======================================= */
        .progress-container {
            width: 90%;
            max-width: 250px;
            height: 15px;
            background-color: #c6c6c6;
            border: 2px solid var(--mc-border-dark);
            box-shadow: 2px 2px 0px var(--mc-border-dark);
            margin-top: 10px;
        }
        
        #block-progress {
            height: 100%;
            background-color: #ff0000;
            transition: width 0.1s;
        }
        
        /* ======================================= */
        /* == Inventory & Hotbar == */
        /* ======================================= */
        #inventory-bar {
            width: 100%;
            max-width: 450px;
            height: 70px;
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .inventory-slot {
            width: 60px;
            height: 60px;
            background-color: var(--mc-inventory-bg);
            border: 3px solid var(--mc-border-dark);
            box-shadow: inset 2px 2px 0px #fff, inset -2px -2px 0px #3c3c3c;
            position: relative;
            cursor: pointer;
        }
        .inventory-slot.equipped {
            border: 3px solid #ffcc00; /* –ó–æ–ª–æ—Ç–∏–π –±–æ—Ä–¥–µ—Ä –¥–ª—è –µ–∫—ñ–ø—ñ—Ä–æ–≤–∞–Ω–æ–≥–æ */
        }
        
        .resource-count {
            position: absolute;
            bottom: 0;
            right: 0;
            font-size: 8px;
            padding: 1px 3px;
            background-color: rgba(0, 0, 0, 0.7);
            color: yellow;
        }
        .resource-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        
        /* Skin Display */
        #player-skin-display {
            font-size: 30px;
            margin-bottom: 5px;
            text-shadow: none;
        }
        
    </style>
</head>
<body>
    
    <div id="main-menu" class="mc-ui">
        <h1>MINE FARM</h1>
        <div id="player-skin-display">üßç</div>
        <button class="mc-button" onclick="showWorldMenu()">‚ñ∂Ô∏è –ì—Ä–∞—Ç–∏</button>
        <button class="mc-button" onclick="createNewWorldMenu()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –°–≤—ñ—Ç</button>
        <button class="mc-button" onclick="showSkinShop()">üëï –ú–∞–≥–∞–∑–∏–Ω –°–∫—ñ–Ω—ñ–≤</button>
        <button class="mc-button" onclick="telegramSaveAndClose()">üö™ –í–∏—Ö—ñ–¥</button>
    </div>

    <div id="world-menu" style="display:none;" class="mc-ui">
        <h2>–û–ë–†–ê–¢–ò –°–í–Ü–¢</h2>
        <div id="worlds-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
        <button class="mc-button" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="create-world-menu" style="display:none;" class="mc-ui">
        <h2>–°–¢–í–û–†–ò–¢–ò –°–í–Ü–¢</h2>
        <input type="text" id="world-name-input" class="mc-input" placeholder="–ù–∞–∑–≤–∞ –°–≤—ñ—Ç—É">
        <button class="mc-button" onclick="createWorld()">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞ –ì—Ä–∞—Ç–∏</button>
        <button class="mc-button" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>
    
    <div id="skin-shop-menu" style="display:none;" class="mc-ui">
        <h2>–ú–ê–ì–ê–ó–ò–ù –°–ö–Ü–ù–Ü–í</h2>
        <p style="font-size: 8px; margin: 0;">(–Ü–º—ñ—Ç–∞—Ü—ñ—è –æ–ø–ª–∞—Ç–∏ Telegram Stars)</p>
        <div id="skin-list" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;"></div>
        <button class="mc-button" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="game-container" style="display:none;">
        <div id="world-name" class="mc-ui"></div>
        
        <div id="world-viewport">
            </div>
        
        <div class="progress-container">
            <div id="block-progress"></div>
        </div>

        <div id="inventory-bar">
            </div>
    </div>
    
    <audio id="sound-tap" src="tap.mp3"></audio>
    <audio id="sound-break" src="break.mp3"></audio>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // =======================================
        // == –ö–û–ù–°–¢–ê–ù–¢–ò, –î–ê–ù–Ü, –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ==
        // =======================================
        const WORLD_SIZE_X = 15; // –ó–±—ñ–ª—å—à–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫—Ä–∞—â–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
        const WORLD_SIZE_Y = 10;
        const MINING_POWER = 1;
        const INITIAL_ENERGY = 10;
        const MAX_ENERGY = 10;
        
        // –ú–∞–ø–∞ –±–ª–æ–∫—ñ–≤
        const BLOCKS = {
            AIR: { id: 0, icon: '', css: 'block-air', unbreakable: true, name: 'Air' },
            GRASS: { id: 1, icon: 'üåø', css: 'block-grass', hardness: 3, drops: 'DIRT', name: 'Grass' },
            DIRT: { id: 2, icon: 'üü§', css: 'block-dirt', hardness: 2, drops: 'DIRT', name: 'Dirt' },
            STONE: { id: 3, icon: 'ü™®', css: 'block-stone', hardness: 5, drops: 'STONE', name: 'Stone' },
            WATER: { id: 4, icon: 'üíß', css: 'block-water', hardness: 100, drops: 'NONE', name: 'Water', unbreakable: true },
            COAL_ORE: { id: 5, icon: '‚ö´', css: 'block-coal', hardness: 8, drops: 'COAL', name: 'Coal Ore' },
            IRON_ORE: { id: 6, icon: 'üî©', css: 'block-iron', hardness: 12, drops: 'IRON', name: 'Iron Ore' },
            DIAMOND_ORE: { id: 7, icon: 'üíé', css: 'block-diamond', hardness: 20, drops: 'DIAMOND', name: 'Diamond Ore' },
            LOG: { id: 8, icon: 'ü™µ', css: 'block-log', hardness: 4, drops: 'WOOD', name: 'Wood Log' }
        };
        
        // –®–∞–Ω—Å–∏ –≤–∏–ø–∞–¥—ñ–Ω–Ω—è —Ä—É–¥–∏ (—á–∏–º –Ω–∏–∂—á–µ Y, —Ç–∏–º –∫—Ä–∞—â–∞ —Ä—É–¥–∞)
        const ORE_CHANCES = [
             { block: BLOCKS.COAL_ORE, chance: 0.15, maxDepth: 7 },
             { block: BLOCKS.IRON_ORE, chance: 0.08, maxDepth: 5 },
             { block: BLOCKS.DIAMOND_ORE, chance: 0.03, maxDepth: 3 }
        ];
        
        const SKIN_OPTIONS = [
            { id: 'DEFAULT', name: '–°—Ç—ñ–≤ (–ë–∞–∑–æ–≤–∏–π)', icon: 'üßç', purchased: true, price: 0 },
            { id: 'DIAMOND', name: '–î—ñ–∞–º–∞–Ω—Ç', icon: 'üíé', purchased: false, price: 50 },
            { id: 'ZOMBIE', name: '–ó–æ–º–±—ñ', icon: 'üßü', purchased: false, price: 20 },
            { id: 'CREEPER', name: '–ö—Ä—ñ–ø–µ—Ä', icon: 'üí£', purchased: false, price: 35 }
        ];

        let GAME_STATE = {
            currentWorld: null,
            worlds: {},
            energy: INITIAL_ENERGY,
            selectedSkin: 'DEFAULT'
        };
        
        // DOM –ï–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è –ó–≤—É–∫—ñ–≤
        const SOUNDS = {
            tap: document.getElementById('sound-tap'),
            break: document.getElementById('sound-break')
        };
        
        // =======================================
        // == –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• ==
        // =======================================

        function loadGameState() {
            const savedState = localStorage.getItem('mineFarmState');
            if (savedState) {
                GAME_STATE = JSON.parse(savedState);
                GAME_STATE.energy = Math.min(GAME_STATE.energy || INITIAL_ENERGY, MAX_ENERGY); // –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –ª—ñ–º—ñ—Ç –µ–Ω–µ—Ä–≥—ñ—ó
            }
        }

        function saveGameState() {
            localStorage.setItem('mineFarmState', JSON.stringify(GAME_STATE));
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ –±–æ—Ç—É –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó/–±–µ–∫-–∞–ø—É
            if (GAME_STATE.currentWorld && GAME_STATE.worlds[GAME_STATE.currentWorld]) {
                Telegram.WebApp.sendData(JSON.stringify(GAME_STATE.worlds[GAME_STATE.currentWorld])); 
            }
        }
        
        // =======================================
        // == –ì–ï–ù–ï–†–ê–¶–Ü–Ø –°–í–Ü–¢–£ (–†–æ–∑—à–∏—Ä–µ–Ω–∞ 2D) ==
        // =======================================

        function generateWorld(name) {
            const newWorld = [];
            
            for (let y = 0; y < WORLD_SIZE_Y; y++) {
                for (let x = 0; x < WORLD_SIZE_X; x++) {
                    let blockType = BLOCKS.AIR.id;
                    
                    const depth = WORLD_SIZE_Y - y; // –ì–ª–∏–±–∏–Ω–∞
                    
                    if (depth === 1) { // –í–µ—Ä—Ö–Ω—ñ–π —à–∞—Ä
                        const rand = Math.random();
                        if (rand < 0.85) {
                             blockType = BLOCKS.GRASS.id;
                        } else if (rand < 0.95) {
                             blockType = BLOCKS.WATER.id; // –í–æ–¥–∞ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω—ñ
                        } else {
                            blockType = BLOCKS.GRASS.id; // –ó–∞–≤–∂–¥–∏ —Ç—Ä–∞–≤–∞, —â–æ–± –¥–µ—Ä–µ–≤–∞ —Ä–æ—Å–ª–∏
                        }
                    } else if (depth > 1 && depth < 4) { // –ü—ñ–¥–∑–µ–º–Ω—ñ —à–∞—Ä–∏ (—Ä—É–¥–∞)
                        blockType = BLOCKS.DIRT.id;
                        
                        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä—É–¥–∏
                        for(const ore of ORE_CHANCES) {
                            if (depth <= ore.maxDepth && Math.random() < ore.chance) {
                                blockType = ore.block.id;
                                break;
                            }
                        }
                    } else if (depth >= 4) {
                        blockType = BLOCKS.STONE.id;
                        
                        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≥–ª–∏–±–æ–∫–æ—ó —Ä—É–¥–∏
                         for(const ore of ORE_CHANCES) {
                            if (depth <= ore.maxDepth + 3 && Math.random() < ore.chance / 2) {
                                blockType = ore.block.id;
                                break;
                            }
                        }
                    }
                    
                    newWorld.push({ 
                        id: blockType, 
                        hp: BLOCKS[Object.keys(BLOCKS).find(key => BLOCKS[key].id === blockType)].hardness || 1 
                    });
                }
            }
            
            // –î–æ–¥–∞—î–º–æ –¥–µ—Ä–µ–≤–∞ (—ñ–º—ñ—Ç–∞—Ü—ñ—è)
            for (let i = 0; i < 3; i++) {
                const treeX = Math.floor(Math.random() * (WORLD_SIZE_X - 2)) + 1;
                const topBlockIndex = (WORLD_SIZE_Y - 1) * WORLD_SIZE_X + treeX;
                if (newWorld[topBlockIndex].id === BLOCKS.GRASS.id) {
                    newWorld[topBlockIndex - WORLD_SIZE_X].id = BLOCKS.LOG.id;
                }
            }
            
            GAME_STATE.worlds[name] = {
                data: newWorld,
                inventory: { WOOD: 0, DIRT: 0, STONE: 0, COAL: 0, IRON: 0, DIAMOND: 0 },
                playerSkin: GAME_STATE.selectedSkin
            };
            saveGameState();
            return name;
        }

        // =======================================
        // == UI & RENDER ==
        // =======================================

        function getBlockInfo(id) {
            return Object.values(BLOCKS).find(b => b.id === id) || BLOCKS.AIR;
        }

        function renderWorld(worldName) {
            const worldData = GAME_STATE.worlds[worldName].data;
            const viewport = document.getElementById('world-viewport');
            viewport.innerHTML = '';
            
            viewport.style.setProperty('--world-cols', WORLD_SIZE_X);

            worldData.forEach((blockState, index) => {
                const blockInfo = getBlockInfo(blockState.id);
                const blockElement = document.createElement('div');
                
                blockElement.className = `block ${blockInfo.css}`;
                blockElement.dataset.index = index;
                blockElement.dataset.hp = blockState.hp;
                blockElement.textContent = blockInfo.icon;
                
                if (!blockInfo.unbreakable) {
                    blockElement.onclick = handleBlockClick;
                }
                viewport.appendChild(blockElement);
            });
            
            renderInventory(GAME_STATE.worlds[worldName].inventory);
            updateMainUi(worldName);
        }
        
        function updateMainUi(worldName) {
             document.getElementById('world-name').textContent = `–°–≤—ñ—Ç: ${worldName} | –ï–Ω–µ—Ä–≥—ñ—è: ${GAME_STATE.energy}/${MAX_ENERGY}`;
        }


        function renderInventory(inventory) {
            const bar = document.getElementById('inventory-bar');
            bar.innerHTML = '';
            
            for (const item in inventory) {
                const itemBlock = BLOCKS[item] || { icon: '‚ùì', name: item };
                
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.dataset.item = item;
                slot.title = itemBlock.name;
                
                const icon = document.createElement('span');
                icon.className = 'resource-icon';
                icon.textContent = itemBlock.icon;
                
                const count = document.createElement('span');
                count.className = 'resource-count';
                count.textContent = inventory[item];
                
                slot.appendChild(icon);
                slot.appendChild(count);
                bar.appendChild(slot);
            }
        }
        
        function updateWorldsList() {
            const listContainer = document.getElementById('worlds-list');
            listContainer.innerHTML = '';
            
            if (Object.keys(GAME_STATE.worlds).length === 0) {
                listContainer.innerHTML += '<p style="font-size: 8px;">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Å–≤—ñ—Ç—ñ–≤.</p>';
                return;
            }
            
            for (const name in GAME_STATE.worlds) {
                const button = document.createElement('button');
                button.className = 'mc-button';
                button.textContent = `‚ñ∂Ô∏è –ó–ê–í–ê–ù–¢–ê–ñ–ò–¢–ò ${name}`;
                button.onclick = () => startGame(name);
                listContainer.appendChild(button);
            }
        }

        function renderSkinShop() {
            const shopList = document.getElementById('skin-list');
            shopList.innerHTML = '';

            SKIN_OPTIONS.forEach(skin => {
                const isEquipped = GAME_STATE.selectedSkin === skin.id;
                const isPurchased = skin.purchased || SKIN_OPTIONS.find(s => s.id === skin.id).purchased; // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—É–ø–ª–µ–Ω–∏—Ö
                
                const div = document.createElement('div');
                div.className = 'mc-ui';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.fontSize = '10px';

                div.innerHTML = `
                    <span>${skin.icon} ${skin.name}</span>
                    <button class="mc-button" style="font-size: 8px; padding: 5px; margin: 0;" 
                        onclick="handleSkinPurchase('${skin.id}', ${skin.price})">
                        ${isEquipped ? '–ï–ö–Ü–ü–Ü–†–û–í–ê–ù–û' : (isPurchased ? '–í–ò–ë–†–ê–¢–ò' : skin.price + ' ‚≠êÔ∏è –ö–£–ü–ò–¢–ò')}
                    </button>
                `;
                shopList.appendChild(div);
            });
            document.getElementById('player-skin-display').textContent = SKIN_OPTIONS.find(s => s.id === GAME_STATE.selectedSkin).icon;
        }
        
        // =======================================
        // == GAME LOGIC ==
        // =======================================
        
        function handleBlockClick(e) {
            if (GAME_STATE.energy < 1) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                return;
            }

            const index = parseInt(e.currentTarget.dataset.index);
            const currentWorld = GAME_STATE.worlds[GAME_STATE.currentWorld];
            let currentBlock = currentWorld.data[index];
            const blockInfo = getBlockInfo(currentBlock.id);
            
            if (blockInfo.unbreakable || currentBlock.id === BLOCKS.AIR.id) return;
            
            // 1. –í–∏—Ç—Ä–∞—Ç–∏ —Ç–∞ –ó–≤—É–∫
            GAME_STATE.energy -= 1;
            playSound('tap');

            // 2. –ó–º–µ–Ω—à—É—î–º–æ –∑–¥–æ—Ä–æ–≤'—è –±–ª–æ–∫—É
            currentBlock.hp -= MINING_POWER;
            
            // –í—ñ–∑—É–∞–ª—å–Ω–µ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
            e.currentTarget.classList.add('damaged');
            setTimeout(() => e.currentTarget.classList.remove('damaged'), 100);
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä—É
            const blockProgressPercent = (currentBlock.hp / blockInfo.hardness) * 100;
            document.getElementById('block-progress').style.width = `${blockProgressPercent}%`;
            document.getElementById('block-progress').style.backgroundColor = blockProgressPercent > 30 ? '#ffcc00' : '#ff0000';
            
            if (currentBlock.hp <= 0) {
                // 3. –ë–ª–æ–∫ –∑–Ω–∏—â–µ–Ω–æ
                playSound('break');
                
                const itemToDrop = blockInfo.drops;
                currentWorld.inventory[itemToDrop] = (currentWorld.inventory[itemToDrop] || 0) + 1;
                
                // –ó–º—ñ–Ω–∞ –±–ª–æ–∫—É –Ω–∞ –ø–æ–≤—ñ—Ç—Ä—è
                currentBlock.id = BLOCKS.AIR.id;
                currentBlock.hp = 1; // –°–∫–∏–¥–∞—î–º–æ HP
                
                e.currentTarget.className = 'block block-air';
                e.currentTarget.textContent = '';
                
                renderInventory(currentWorld.inventory);
            }
            
            updateMainUi(GAME_STATE.currentWorld);
            saveGameState();
        }
        
        // =======================================
        // == ENERGY REGENERATION & SOUNDS ==
        // =======================================

        let regenIntervalId;
        
        function startRegen() {
             if (regenIntervalId) clearInterval(regenIntervalId);
             
             regenIntervalId = setInterval(() => {
                if (GAME_STATE.energy < MAX_ENERGY) {
                    GAME_STATE.energy = Math.min(GAME_STATE.energy + 1, MAX_ENERGY);
                    updateMainUi(GAME_STATE.currentWorld);
                    saveGameState();
                }
            }, 5000); // –†–µ–≥–µ–Ω 1 –µ–Ω–µ—Ä–≥—ñ—ó –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
        }
        
        function playSound(type) {
             if (SOUNDS[type]) {
                 SOUNDS[type].currentTime = 0;
                 SOUNDS[type].play().catch(e => console.log('Sound blocked'));
             }
        }

        // =======================================
        // == MENU HANDLERS & NAVIGATION ==
        // =======================================

        function startGame(worldName) {
            GAME_STATE.currentWorld = worldName;
            
            // –°—Ö–æ–≤–∞—Ç–∏/–ü–æ–∫–∞–∑–∞—Ç–∏
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('world-menu').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
            renderWorld(worldName);
            startRegen();
            
            Telegram.WebApp.MainButton.setText(`–ó–ë–ï–†–ï–ì–¢–ò –Ü–ù–í–ï–ù–¢–ê–†`);
            Telegram.WebApp.MainButton.show();
        }

        function createWorld() {
            const nameInput = document.getElementById('world-name-input');
            const name = nameInput.value.trim();
            
            if (name && !GAME_STATE.worlds[name]) {
                generateWorld(name);
                nameInput.value = '';
                startGame(name);
            } else {
                alert("–ù–µ–¥—ñ–π—Å–Ω–∞ –Ω–∞–∑–≤–∞ –∞–±–æ —Å–≤—ñ—Ç –≤–∂–µ —ñ—Å–Ω—É—î.");
            }
        }
        
        function handleSkinPurchase(skinId, price) {
            const skin = SKIN_OPTIONS.find(s => s.id === skinId);
            const isEquipped = GAME_STATE.selectedSkin === skinId;

            if (isEquipped) {
                 alert(`–°–∫—ñ–Ω ${skin.name} –≤–∂–µ –µ–∫—ñ–ø—ñ—Ä–æ–≤–∞–Ω–æ!`);
                 return;
            }

            if (skin.purchased) {
                // –ï–∫—ñ–ø—ñ—Ä—É–≤–∞–Ω–Ω—è
                GAME_STATE.selectedSkin = skinId;
                saveGameState();
                alert(`–í–∏ –æ–±—Ä–∞–ª–∏ —Å–∫—ñ–Ω ${skin.name}!`);
                renderSkinShop();
                return;
            }

            // –Ü–º—ñ—Ç–∞—Ü—ñ—è –æ–ø–ª–∞—Ç–∏ Stars: –¶–ï–ô –ö–û–î –í–ò–ö–õ–ò–ö–ê–Ñ –ë–û–¢ –ù–ê –ó–ê–î–ù–¨–û–ú–£ –ü–õ–ê–ù–Ü!
            // –î–ª—è —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—É Telegram Stars —Ç—É—Ç –º–∞—î –±—É—Ç–∏ –≥–ª–∏–±–æ–∫–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è Payment API
            
            if (confirm(`–í–∏ –¥—ñ–π—Å–Ω–æ –±–∞–∂–∞—î—Ç–µ –ø—Ä–∏–¥–±–∞—Ç–∏ —Å–∫—ñ–Ω ${skin.name} –∑–∞ ${price} ‚≠êÔ∏è?`)) {
                // –Ü–º—ñ—Ç—É—î–º–æ —É—Å–ø—ñ—à–Ω—É –æ–ø–ª–∞—Ç—É:
                skin.purchased = true;
                GAME_STATE.selectedSkin = skinId;
                saveGameState();
                alert(`‚úÖ –°–∫—ñ–Ω ${skin.name} –ø—Ä–∏–¥–±–∞–Ω–æ!`);
                renderSkinShop();
            }
        }
        
        function showMainMenu() {
            // –°–∫–∏–¥–∞–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('world-menu').style.display = 'none';
            document.getElementById('create-world-menu').style.display = 'none';
            document.getElementById('skin-shop-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
            
            Telegram.WebApp.MainButton.hide();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–∫—ñ–Ω —É –º–µ–Ω—é
            document.getElementById('player-skin-display').textContent = SKIN_OPTIONS.find(s => s.id === GAME_STATE.selectedSkin).icon;
        }

        function showWorldMenu() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('world-menu').style.display = 'flex';
            updateWorldsList();
        }
        
        function createNewWorldMenu() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('create-world-menu').style.display = 'flex';
        }

        function showSkinShop() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('skin-shop-menu').style.display = 'flex';
            renderSkinShop();
        }

        function telegramSaveAndClose() {
            if (GAME_STATE.currentWorld) {
                saveGameState();
            }
            Telegram.WebApp.close();
        }


        // =======================================
        // == INIT ==
        // =======================================
        
        function initWebApp() {
            Telegram.WebApp.ready();
            loadGameState();
            
            Telegram.WebApp.MainButton.onClick(telegramSaveAndClose);
            Telegram.WebApp.onEvent('settingsButtonClicked', showMainMenu);
            
            showMainMenu();
        }
        
        initWebApp();
    </script>
</body>
</html>
