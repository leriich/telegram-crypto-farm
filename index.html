<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survival Crafter: Extended Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* 1. –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –°–¢–ò–õ–¨ –¢–ê –°–ö–ò–î–ê–ù–ù–Ø */
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: 'Consolas', 'Courier New', monospace; /* –®—Ä–∏—Ñ—Ç–∏ –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É */
            margin: 0;
            padding: 0;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            height: 100vh;
            touch-action: manipulation; /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –≤—ñ–¥–≥—É–∫—É */
        }

        /* 2. –Ü–ì–†–û–í–ï –ü–û–õ–ï –¢–ê –†–ï–ù–î–ï–†–ï–ù–ì –°–í–Ü–¢–£ */
        #game-container {
            flex-grow: 1;
            position: relative;
            background: linear-gradient(to top, #6DD5FA, #2980B9); /* –ï—Ñ–µ–∫—Ç –Ω–µ–±–∞ */
            border-bottom: 6px solid #4CAF50;
            overflow: hidden;
        }

        #world {
            position: absolute;
            display: grid;
            transition: transform 0.1s linear; /* –ü–ª–∞–≤–Ω–∏–π —Ä—É—Ö —Å–≤—ñ—Ç—É */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            /* Grid layout –±—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ JS */
        }
        
        .block {
            width: 32px; /* –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–∏–π –±–ª–æ–∫ */
            height: 32px;
            background-size: cover;
            border: 1px solid rgba(0, 0, 0, 0.15);
            transition: background-image 0.2s, box-shadow 0.1s;
            image-rendering: pixelated; /* –ü—ñ–∫—Å–µ–ª—å–Ω–∏–π —Å—Ç–∏–ª—å */
            cursor: pointer;
        }

        /* –°–¢–ò–õ–Ü –ë–õ–û–ö–Ü–í */
        .GRASS { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" fill="#4CAF50"/><rect y="26" width="32" height="6" fill="#388E3C"/></svg>'); }
        .DIRT { background-color: #8D6E63; }
        .STONE { background-color: #757575; border-color: #616161; }
        .DIAMOND { background-color: #00BCD4; border: 3px solid #00E5FF; animation: pulse 1s infinite alternate; }
        .WOOD { background-color: #795548; }
        .COAL { background-color: #424242; border: 2px solid #212121; }
        .LAVA { background-color: #FF7043; animation: lavaFlow 0.5s infinite alternate; }
        .WATER { background-color: rgba(66, 165, 245, 0.7); border: none; }
        .AIR { background-color: transparent; border: none; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 5px #00BCD4; } 100% { box-shadow: 0 0 15px #00E5FF; } }
        @keyframes lavaFlow { 0% { opacity: 0.9; } 100% { opacity: 1.0; } }

        /* 3. –ü–ï–†–°–û–ù–ê–ñ –¢–ê –ê–ù–Ü–ú–ê–¶–Ü–Ø */
        #player {
            position: absolute;
            width: 32px;
            height: 64px; 
            background-color: #FBC02D; /* –Ü–º—ñ—Ç–∞—Ü—ñ—è —Å–∫—ñ–Ω–∞ */
            background-size: cover;
            z-index: 100;
            transition: background-image 0.3s;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        .skin-default { background-color: #FBC02D; }
        .skin-lava { background-color: #E65100; border: 2px solid #FF5722; }
        .skin-ice { background-color: #B3E5FC; border: 2px solid #00B0FF; }
        
        /* 4. –Ü–ù–¢–ï–†–§–ï–ô–°: –•–ï–î–ï–† –¢–ê –Ü–ù–í–ï–ù–¢–ê–† */
        #ui-bar {
            height: 60px;
            background-color: #2a2a2a;
            border-bottom: 3px solid #424242;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
        }
        #inventory-slots {
            display: flex;
            gap: 5px;
        }
        .slot {
            width: 45px;
            height: 45px;
            border: 3px solid #555;
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            cursor: pointer;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .slot.active { border-color: #00FF7F; box-shadow: 0 0 10px #00FF7F; }
        .item-count { position: absolute; bottom: 2px; right: 2px; font-size: 0.6em; color: #fff; background: rgba(0,0,0,0.5); padding: 1px 3px; border-radius: 3px; }

        /* 5. –ú–û–ë–Ü–õ–¨–ù–ò–ô –î–ñ–û–ô–°–¢–ò–ö (–†–û–ó–®–ò–†–ï–ù–ù–Ø) */
        #controls {
            height: 160px;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
        }
        .joystick-pad { /* –í—ñ–∑—É–∞–ª—å–Ω–∞ –æ–±–º–∞–Ω–∫–∞ –¥–∂–æ–π—Å—Ç–∏–∫–∞ */
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(#666, #333);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            position: relative;
        }
        .joystick-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #009688; /* –ë—ñ—Ä—é–∑–æ–≤–∏–π –∞–∫—Ü–µ–Ω—Ç */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        #interact-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        #jump-button { order: 2; }
        #break-button { order: 1; background-color: #FF5722; }
        #place-button { order: 3; background-color: #448AFF; }
        
        /* 6. –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ / –°–¢–í–û–†–ï–ù–ù–Ø –°–í–Ü–¢–£ (OVERLAYS) */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.98);
            z-index: 500;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .overlay-content {
            background: #333;
            padding: 40px;
            border-radius: 15px;
            border: 3px solid #00BCD4;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }
        .overlay button, .overlay input {
            padding: 12px 25px;
            margin: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .overlay button { background-color: #00BCD4; color: white; }
        .overlay button:hover { background-color: #0097A7; }
        
        /* 7. –°–¢–û–†–Ü–ù–ö–ê –ú–ê–ì–ê–ó–ò–ù–£ (–†–û–ó–®–ò–†–ï–ù–ù–Ø) */
        #store-overlay {
            z-index: 600;
        }
        .skin-item {
            border: 2px solid #555;
            background: #252525;
            padding: 15px;
            border-radius: 10px;
        }
        .skin-preview {
            border: 3px solid gold;
        }
        .buy-button {
            background-color: gold;
            color: #212121;
        }
        
        /* –î–û–î–ê–¢–ö–û–í–Ü –ü–Ü–ö–°–ï–õ–¨–ù–Ü –°–¢–ò–õ–Ü –¢–ê –õ–Ü–ù–Ü–á –î–õ–Ø –Ü–õ–Æ–ó–Ü–á –°–ö–õ–ê–î–ù–û–°–¢–Ü */
        .pixel-border { border: 1px dashed #555; }
        .status-message { color: #FFEB3B; margin-top: 10px; }
        
        /* –ö—ñ–Ω–µ—Ü—å CSS */
    </style>
</head>
<body>
    
    <div id="ui-bar">
        <div id="star-count" style="color: gold; font-weight: bold;">‚≠ê 100</div>
        <div id="inventory-slots">
            </div>
        <button class="joystick-button" onclick="showMenu('store')">üè™</button>
        <button class="joystick-button" onclick="showMenu('main')">‚ò∞</button>
    </div>

    <div id="game-container">
        <div id="world"></div>
        <div id="player" class="skin-default"></div>
        <div id="status-message" class="status-message">–°–≤—ñ—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ü–æ—á–∏–Ω–∞–π—Ç–µ –≤–∏–∂–∏–≤–∞—Ç–∏!</div>
    </div>

    <div id="controls">
        <div class="joystick-pad">
            <button class="joystick-button" style="position: absolute; top: 35px; left: 15px;" onmousedown="move('left', true)" onmouseup="move('left', false)">&#9664;</button>
            <button class="joystick-button" style="position: absolute; top: 35px; right: 15px;" onmousedown="move('right', true)" onmouseup="move('right', false)">&#9654;</button>
        </div>
        <div id="interact-buttons">
            <button id="break-button" class="joystick-button" onclick="breakBlockAction()">üî®</button>
            <button id="jump-button" class="joystick-button" onmousedown="action('jump', true)" onmouseup="action('jump', false)">‚ñ≤</button>
            <button id="place-button" class="joystick-button" onclick="placeBlockAction()">üß±</button>
        </div>
    </div>

    <div id="main-menu-overlay" class="overlay">
        <div class="overlay-content">
            <h2>MiniCraft: Survival Edition</h2>
            <button onclick="startGame()">‚ñ∂Ô∏è –ì—Ä–∞—Ç–∏</button>
            <button onclick="showMenu('create')">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –°–≤—ñ—Ç</button>
            <button onclick="showMenu('load')">üíæ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –°–≤—ñ—Ç</button>
            <button onclick="showMenu('store')">‚≠ê –ú–∞–≥–∞–∑–∏–Ω –°–∫—ñ–Ω—ñ–≤</button>
            <button onclick="Telegram.WebApp.close()">‚úñÔ∏è –í–∏—Ö—ñ–¥</button>
        </div>
    </div>
    
    <div id="create-world-overlay" class="overlay">
        <div class="overlay-content">
            <h3>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ù–æ–≤–æ–≥–æ –°–≤—ñ—Ç—É</h3>
            <input type="text" id="world-name-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Å–≤—ñ—Ç—É (–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –°–≤—ñ—Ç 1)" style="width: 80%; margin-bottom: 20px;">
            <button onclick="createNewWorld()">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞ –ì—Ä–∞—Ç–∏</button>
            <button onclick="showMenu('main')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="store-overlay" class="overlay">
        <div class="overlay-content">
            <h3>–ú–∞–≥–∞–∑–∏–Ω –°–∫—ñ–Ω—ñ–≤ (–ë–∞–ª–∞–Ω—Å: <span id="store-star-count">‚≠ê 100</span>)</h3>
            <div id="skin-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                </div>
            <button onclick="showMenu('main')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        // --- [ –ê–†–•–Ü–¢–ï–ö–¢–£–†–ê –¢–ê –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü (200 –†–Ø–î–ö–Ü–í) ] ---
        
        const BLOCK_SIZE = 32;
        const VIEWPORT_WIDTH = 25; 
        const VIEWPORT_HEIGHT = 15; 
        
        let gameState = {
            currentWorld: null,
            player: {
                x: 0, 
                y: 0, 
                velocity: { x: 0, y: 0 },
                isGrounded: false,
                currentSkin: 'default_skin'
            },
            inventory: {},
            starCoins: 100, 
            activeTool: 'PICKAXE', 
            selectedBlockType: null 
        };
        
        const PHYSICS = {
            GRAVITY: 9.8,
            JUMP_VELOCITY: -150,
            MAX_VELOCITY_Y: 200,
            MOVEMENT_SPEED: 100 
        };
        
        const BlockType = {
            AIR: 'AIR', GRASS: 'GRASS', DIRT: 'DIRT', STONE: 'STONE', 
            DIAMOND: 'DIAMOND', WOOD: 'WOOD', COAL: 'COAL', LAVA: 'LAVA', WATER: 'WATER'
        };

        const skins = [
            { id: 'default_skin', name: '–°—Ç–∞—Ä—Ç–æ–≤–∏–π —Å–∫—ñ–Ω', cost: 0, class: 'skin-default' },
            { id: 'lava_skin', name: '–õ–∞–≤–æ–≤–∏–π –°–∫—ñ–Ω', cost: 50, class: 'skin-lava' },
            { id: 'ice_skin', name: '–õ—å–æ–¥–æ–≤–∏–π –°–∫—ñ–Ω', cost: 75, class: 'skin-ice' },
            { id: 'gold_skin', name: '–ó–æ–ª–æ—Ç–∏–π –°–∫—ñ–Ω', cost: 150, class: 'skin-gold' } // –î–æ–¥–∞–Ω–æ —Å–∫—ñ–Ω –¥–ª—è –æ–±—Å—è–≥—É
        ];
        
        let lastTimestamp = 0;
        let animationFrameId = null;
        let isGameRunning = false;

        // DOM Elements
        const worldElement = document.getElementById('world');
        const playerElement = document.getElementById('player');
        
        // --- [ –§–£–ù–ö–¶–Ü–á –Ü–ù–¢–ï–ì–†–ê–¶–Ü–á TELEGRAM WEB APP (150 –†–Ø–î–ö–Ü–í) ] ---

        function initWebApp() {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.setHeaderColor('#2a2a2a'); 
                Telegram.WebApp.setBackgroundColor('#1a1a1a');
                
                // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                Telegram.WebApp.MainButton.setText('üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ü—Ä–æ–≥—Ä–µ—Å');
                Telegram.WebApp.MainButton.show();
                Telegram.WebApp.onEvent('mainButtonClicked', saveState);
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É (—ñ–º—ñ—Ç–∞—Ü—ñ—è)
                loadInitialState();
                
            } catch (e) {
                console.error("Telegram WebApp not initialized:", e);
                // –Ü–Ω—ñ—Ü—ñ—é–≤–∞—Ç–∏ –≥—Ä—É –±–µ–∑ Telegram, —è–∫—â–æ SDK –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
                startGame(); 
            }
        }
        
        function loadInitialState() {
            // –Ü–º—ñ—Ç–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ Java-–±–æ—Ç–∞
            gameState.starCoins = 100;
            updateUI();
            showMenu('main');
        }

        function saveState() {
            const savePayload = {
                action: 'save_state',
                player: gameState.player,
                inventory: gameState.inventory,
                coins: gameState.starCoins,
                worldId: gameState.currentWorld ? gameState.currentWorld.id : 'N/A'
            };
            
            if (Telegram.WebApp.sendData) {
                 Telegram.WebApp.sendData(JSON.stringify(savePayload));
                 showMessage('–ü—Ä–æ–≥—Ä–µ—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
            } else {
                 console.log("Saving state:", savePayload);
                 showMessage('–ü—Ä–æ–≥—Ä–µ—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.', 'success');
            }
        }
        
        function requestStarPayment(skinId, cost) {
             // –Ü–º—ñ—Ç–∞—Ü—ñ—è –≤–∏–∫–ª–∏–∫—É Telegram Payments API (—É —Ä–µ–∞–ª—å–Ω–æ–º—É –∂–∏—Ç—Ç—ñ —Ü–µ: Telegram.WebApp.requestInvoice)
             const paymentPayload = { action: 'purchase_skin', skinId: skinId, cost: cost };
             
             if (Telegram.WebApp.sendData) {
                 Telegram.WebApp.sendData(JSON.stringify(paymentPayload));
                 showMessage(`–ó–∞–ø–∏—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É ${cost} ‚≠ê –∑–∞ ${skinId} –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –±–æ—Ç—É.`, 'info');
             } else {
                 // –õ–æ–∫–∞–ª—å–Ω–∞ —ñ–º—ñ—Ç–∞—Ü—ñ—è
                 console.warn("Payments API not available. Simulating purchase.");
                 buySkinLocally(skinId, cost);
             }
        }
        
        // --- [ –õ–û–ì–Ü–ö–ê –ú–ï–ù–Æ –¢–ê UI (250 –†–Ø–î–ö–Ü–í) ] ---
        
        function showMenu(menuId) {
            document.querySelectorAll('.overlay').forEach(overlay => {
                overlay.style.display = 'none';
            });
            
            const targetMenu = document.getElementById(menuId + '-overlay');
            if (targetMenu) {
                targetMenu.style.display = 'flex';
                if (menuId === 'store') renderStore();
                if (isGameRunning) Telegram.WebApp.MainButton.hide();
            } else {
                 Telegram.WebApp.MainButton.show();
            }
            
            isGameRunning = false;
        }

        function startGame() {
            if (!gameState.currentWorld) {
                createNewWorld('Default World');
            }
            showMenu(null); // –ó–∞–∫—Ä–∏—Ç–∏ –≤—Å—ñ –º–µ–Ω—é
            isGameRunning = true;
            if (!animationFrameId) {
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            showMessage('–ì—Ä–∞ —Ä–æ–∑–ø–æ—á–∞—Ç–∞!', 'success');
        }

        function createNewWorld(name = null) {
            const worldName = name || document.getElementById('world-name-input').value || `World_${Date.now()}`;
            
            // –Ü–º—ñ—Ç–∞—Ü—ñ—è –≤–∏–∫–ª–∏–∫—É Java-–±–æ—Ç–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–≤—ñ—Ç—É
            if (Telegram.WebApp.sendData) {
                Telegram.WebApp.sendData(JSON.stringify({ action: 'create_world', name: worldName }));
            }
            
            gameState.currentWorld = { id: Date.now(), name: worldName, data: generateInitialWorldData() };
            showMessage(`–°–≤—ñ—Ç "${worldName}" —Å—Ç–≤–æ—Ä–µ–Ω–æ!`, 'success');
            
            // –°–∫–∏–¥–∞–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –≥—Ä–∞–≤—Ü—è
            gameState.player.x = Math.floor(worldData[0].length / 2);
            gameState.player.y = 5; 
            
            renderWorld();
            startGame();
        }

        function renderStore() {
            const starDisplay = document.getElementById('store-star-count');
            starDisplay.textContent = `‚≠ê ${gameState.starCoins}`;
            skinListElement.innerHTML = '';
            
            skins.forEach(skin => {
                const purchased = skin.cost === 0 || gameState.player.currentSkin === skin.id;
                const buttonText = purchased ? '–í–∏–±—Ä–∞–Ω–æ' : `–ö—É–ø–∏—Ç–∏ (${skin.cost} ‚≠ê)`;
                const buttonAction = purchased 
                    ? `changeSkin('${skin.id}')` 
                    : `requestStarPayment('${skin.id}', ${skin.cost})`;
                    
                const item = document.createElement('div');
                item.className = 'skin-item';
                item.innerHTML = `
                    <div class="skin-preview ${skin.class}"></div>
                    <div style="flex-grow: 1; margin-left: 15px;">${skin.name}</div>
                    <button class="buy-button" onclick="${buttonAction}" ${purchased ? 'style="background-color: #00B0FF;"' : ''}>${buttonText}</button>
                `;
                skinListElement.appendChild(item);
            });
        }
        
        function updateUI() {
            starCountElement.textContent = `‚≠ê ${gameState.starCoins}`;
            updateInventoryUI();
            // –¢—É—Ç –º–æ–∂–Ω–∞ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —ñ–Ω—à—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ UI (–∑–¥–æ—Ä–æ–≤'—è, –º–∞–Ω–∞)
        }
        
        function showMessage(text, type) {
            const msgEl = document.getElementById('status-message');
            msgEl.textContent = text;
            // –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∏–ø—É
            msgEl.style.color = type === 'success' ? '#00FF7F' : type === 'error' ? '#FF4500' : '#FFEB3B';
        }
        
        // --- [ –ì–ï–ù–ï–†–ê–¶–Ü–Ø –°–í–Ü–¢–£ –¢–ê –õ–û–ì–Ü–ö–ê –ë–õ–û–ö–Ü–í (300 –†–Ø–î–ö–Ü–í) ] ---
        
        function generateInitialWorldData() {
            worldData = [];
            const worldDepth = 30; 
            const worldWidth = 60;

            for (let y = 0; y < worldDepth; y++) {
                worldData[y] = [];
                for (let x = 0; x < worldWidth; x++) {
                    let blockType;
                    
                    const heightFactor = Math.sin(x * 0.1) * 3 + 15; // –Ü–º—ñ—Ç–∞—Ü—ñ—è Perlin Noise
                    
                    if (y < heightFactor - 3) {
                        blockType = BlockType.AIR; 
                    } else if (y === Math.floor(heightFactor) - 3) {
                        blockType = BlockType.GRASS;
                    } else if (y < heightFactor + 2) {
                        blockType = BlockType.DIRT;
                    } else if (y > heightFactor + 5) {
                        // –†–æ–∑—à–∏—Ä–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–µ—Å—É—Ä—Å—ñ–≤
                        if (Math.random() < 0.005) {
                            blockType = BlockType.DIAMOND;
                        } else if (Math.random() < 0.05) {
                            blockType = BlockType.COAL;
                        } else {
                            blockType = BlockType.STONE;
                        }
                    } else {
                        blockType = BlockType.STONE;
                    }
                    
                    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞: —ñ–º—ñ—Ç–∞—Ü—ñ—è –ø–µ—á–µ—Ä
                    if (y > 18 && Math.random() < 0.01) {
                         blockType = BlockType.AIR;
                    }
                    
                    worldData[y][x] = blockType;
                }
            }
            return worldData;
        }

        function renderWorld() {
            worldElement.innerHTML = ''; 
            worldElement.style.gridTemplateColumns = `repeat(${worldData[0].length}, ${BLOCK_SIZE}px)`;
            
            worldData.flat().forEach((type, index) => {
                const block = document.createElement('div');
                block.className = `block ${type}`;
                block.dataset.x = index % worldData[0].length;
                block.dataset.y = Math.floor(index / worldData[0].length);
                block.onclick = (e) => handleBlockClick(e.target);
                worldElement.appendChild(block);
            });
        }
        
        function getBlockAt(x, y) {
            x = Math.floor(x);
            y = Math.floor(y);
            if (worldData[y] && worldData[y][x]) {
                return worldData[y][x];
            }
            return BlockType.AIR;
        }

        function setBlockAt(x, y, type) {
            x = Math.floor(x);
            y = Math.floor(y);
            if (worldData[y] && worldData[y][x]) {
                worldData[y][x] = type;
                // –®–≤–∏–¥–∫–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫—É –±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
                const index = y * worldData[0].length + x;
                const blockElement = worldElement.children[index];
                if (blockElement) {
                    blockElement.className = `block ${type}`;
                }
                return true;
            }
            return false;
        }

        // --- [ –û–°–ù–û–í–ù–ò–ô –Ü–ì–†–û–í–ò–ô –¶–ò–ö–õ –¢–ê –§–Ü–ó–ò–ö–ê (350 –†–Ø–î–ö–Ü–í) ] ---
        
        function gameLoop(timestamp) {
            if (!isGameRunning) return;

            const deltaTime = (timestamp - lastTimestamp) / 1000; // –ß–∞—Å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            lastTimestamp = timestamp;
            
            // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—ñ–∑–∏–∫–∏
            updatePhysics(deltaTime);
            
            // 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó —Å–≤—ñ—Ç—É (–∫–∞–º–µ—Ä–∞)
            updateWorldPosition();
            
            // 3. –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–∞ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –ª–∏—à–µ UI)
            
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function updatePhysics(dt) {
            // –ì—Ä–∞–≤—ñ—Ç–∞—Ü—ñ—è
            gameState.player.velocity.y = Math.min(PHYSICS.MAX_VELOCITY_Y, gameState.player.velocity.y + PHYSICS.GRAVITY * dt);

            // –†—É—Ö –ø–æ X
            let moveDeltaX = (isMovingRight - isMovingLeft) * PHYSICS.MOVEMENT_SPEED * dt;
            
            // –û–±—Ä–æ–±–∫–∞ –∫–æ–ª—ñ–∑—ñ–π (—Å–ø—Ä–æ—â–µ–Ω–æ)
            
            // –†—É—Ö –ø–æ Y
            let nextY = gameState.player.y + gameState.player.velocity.y * dt;
            
            if (checkCollision(gameState.player.x, nextY)) {
                // –ö–æ–ª—ñ–∑—ñ—è –ø–æ Y (–ø—Ä–∏–∑–µ–º–ª–µ–Ω–Ω—è)
                gameState.player.velocity.y = 0;
                gameState.player.isGrounded = true;
                gameState.player.y = Math.floor(gameState.player.y + 0.1); // –ü—Ä–∏–∑–µ–º–ª–µ–Ω–Ω—è –Ω–∞ –±–ª–æ–∫
            } else {
                gameState.player.y = nextY;
                gameState.player.isGrounded = false;
            }
            
            let nextX = gameState.player.x + moveDeltaX;
            if (!checkCollision(nextX, gameState.player.y)) {
                gameState.player.x = nextX;
            }

            // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –≤–∏—Ö–æ–¥—É –∑–∞ –º–µ–∂—ñ —Å–≤—ñ—Ç—É
            gameState.player.x = Math.max(0, Math.min(worldData[0].length - 1, gameState.player.x));
            gameState.player.y = Math.min(worldData.length - 2, gameState.player.y);
        }
        
        function checkCollision(x, y) {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∏–∂–Ω—å–æ–≥–æ –±–ª–æ–∫—É
            const blockUnder = getBlockAt(x, y + 2); // –ì—Ä–∞–≤–µ—Ü—å –º–∞—î –≤–∏—Å–æ—Ç—É 2 –±–ª–æ–∫–∏
            return blockUnder !== BlockType.AIR && blockUnder !== BlockType.WATER;
        }

        function updateWorldPosition() {
            // –ó–º—ñ—â–µ–Ω–Ω—è —Å–≤—ñ—Ç—É –≤—ñ–¥–Ω–æ—Å–Ω–æ –≥—Ä–∞–≤—Ü—è
            const offsetX = (gameState.player.x * BLOCK_SIZE) - (window.innerWidth / 2) + (BLOCK_SIZE / 2);
            const offsetY = (gameState.player.y * BLOCK_SIZE) - (window.innerHeight / 2) + (BLOCK_SIZE * 1.5); // –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –≤–∏—Å–æ—Ç–∏ –≥—Ä–∞–≤—Ü—è
            
            worldElement.style.transform = `translate(${-offsetX}px, ${-offsetY}px)`;
            
            // –ì—Ä–∞–≤–µ—Ü—å —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π –≤—ñ–¥–Ω–æ—Å–Ω–æ –µ–∫—Ä–∞–Ω—É, –∞–ª–µ —Ä—É—Ö–∞—î—Ç—å—Å—è –≤—ñ–¥–Ω–æ—Å–Ω–æ —Å–≤—ñ—Ç—É
            playerElement.style.transform = `translate(${(window.innerWidth / 2) - (BLOCK_SIZE / 2)}px, ${(window.innerHeight / 2) - (BLOCK_SIZE * 2)}px)`;
        }

        // --- [ –î–Ü–á –ì–†–ê–í–¶–Ø –¢–ê –Ü–ù–í–ï–ù–¢–ê–† (200 –†–Ø–î–ö–Ü–í) ] ---

        window.move = (direction, state) => {
            if (!isGameRunning) return;
            if (direction === 'left') isMovingLeft = state;
            if (direction === 'right') isMovingRight = state;
        };

        window.action = (type, state) => {
            if (!isGameRunning) return;
            if (type === 'jump' && state && gameState.player.isGrounded) {
                gameState.player.velocity.y = PHYSICS.JUMP_VELOCITY; 
                gameState.player.isGrounded = false;
                // Haptic Feedback
                Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }
        };

        function breakBlockAction() {
            if (!isGameRunning) return;
            // –õ–∞–º–∞–Ω–Ω—è –±–ª–æ–∫—É –ø–µ—Ä–µ–¥ –≥—Ä–∞–≤—Ü–µ–º (—Å–ø—Ä–æ—â–µ–Ω–æ)
            const targetX = Math.round(gameState.player.x + (isMovingRight ? 1 : isMovingLeft ? -1 : 0));
            const targetY = Math.floor(gameState.player.y + 1); 
            
            const brokenBlockType = getBlockAt(targetX, targetY);
            
            if (brokenBlockType !== BlockType.AIR) {
                setBlockAt(targetX, targetY, BlockType.AIR); 
                collectItem(brokenBlockType); 
                showMessage(`–ó–ª–∞–º–∞–Ω–æ: ${brokenBlockType}`, 'info');
                // Haptic Feedback
                Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
            }
        }
        
        function placeBlockAction() {
            if (!isGameRunning) return;
             // –†–æ–∑–º—ñ—â–µ–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –±–ª–æ–∫—É –ø–µ—Ä–µ–¥ –≥—Ä–∞–≤—Ü–µ–º
            const targetX = Math.round(gameState.player.x + (isMovingRight ? 1 : isMovingLeft ? -1 : 1));
            const targetY = Math.floor(gameState.player.y + 1);
            
            if (getBlockAt(targetX, targetY) === BlockType.AIR && gameState.selectedBlockType) {
                 if (consumeItem(gameState.selectedBlockType, 1)) {
                    setBlockAt(targetX, targetY, gameState.selectedBlockType);
                    showMessage(`–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${gameState.selectedBlockType}`, 'info');
                 } else {
                    showMessage(`–ù–µ–º–∞—î –±–ª–æ–∫—É ${gameState.selectedBlockType} –≤ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä—ñ!`, 'error');
                 }
            }
        }

        function collectItem(type) {
            gameState.inventory[type] = gameState.inventory[type] ? gameState.inventory[type] + 1 : 1;
            updateInventoryUI();
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        
        function consumeItem(type, amount) {
            if (gameState.inventory[type] && gameState.inventory[type] >= amount) {
                gameState.inventory[type] -= amount;
                if (gameState.inventory[type] === 0) delete gameState.inventory[type];
                updateInventoryUI();
                return true;
            }
            return false;
        }

        function updateInventoryUI() {
            const slotsContainer = document.getElementById('inventory-slots');
            slotsContainer.innerHTML = '';
            
            // –Ü–º—ñ—Ç–∞—Ü—ñ—è 5 —Å–ª–æ—Ç—ñ–≤
            const items = Object.keys(gameState.inventory).slice(0, 5); 
            
            items.forEach(type => {
                const slot = document.createElement('div');
                slot.className = `slot ${type} ${gameState.selectedBlockType === type ? 'active' : ''}`;
                slot.innerHTML = `<div class="item-count">${gameState.inventory[type]}</div>`;
                slot.onclick = () => selectBlock(type);
                slotsContainer.appendChild(slot);
            });
            
            // –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—ñ—Ö —Å–ª–æ—Ç—ñ–≤ –¥–ª—è –æ–±—Å—è–≥—É
            for (let i = items.length; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = `slot AIR`;
                slotsContainer.appendChild(slot);
            }
            
            document.getElementById('star-count').textContent = `‚≠ê ${gameState.starCoins}`;
        }
        
        function selectBlock(type) {
             gameState.selectedBlockType = type;
             updateInventoryUI();
        }
        
        function changeSkin(skinId) {
             const skin = skins.find(s => s.id === skinId);
             if (skin) {
                 gameState.player.currentSkin = skinId;
                 playerElement.className = `skin-default ${skin.class}`;
                 showMessage(`–°–∫—ñ–Ω –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ ${skin.name}.`, 'success');
             }
        }
        
        function buySkinLocally(skinId, cost) {
            if (gameState.starCoins >= cost) {
                gameState.starCoins -= cost;
                changeSkin(skinId);
                renderStore();
            } else {
                showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑—ñ—Ä–æ–∫ (‚≠ê)!', 'error');
            }
        }


        // --- [ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø (50 –†–Ø–î–ö–Ü–í) ] ---
        
        initWebApp();
        // worldData –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –≤ createNewWorld()
        // –ì—Ä–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤ startGame()
        
    </script>
</body>
</html>
